var spawn = require('child_process').spawn;

module.exports = function (args, cb, options) {
    var process = spawn('rsync',args, options);
    var stdout = '';
    var stderr = '';

    process.stdout.setEncoding('utf8');
    process.stderr.setEncoding('utf8');

    process.stdout.on('data', function (data) {
        stdout += data;
    });

    process.stderr.on('data', function (data) {
        stderr += data;
    });

    process.on('exit', function (code) {
        var msg = '';
        var err = null;

        if (code !== 0) {
            err = new Error(stderr);
            msg = stderr;
        } else {
            msg = stdout.toString();
        }

        cb(err, msg);
    });
};